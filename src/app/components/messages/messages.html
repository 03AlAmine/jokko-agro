<div class="messages-container">
  <main class="main-content">
    <div class="messages-layout">
      <!-- Panel des conversations -->
      <div class="conversations-panel">
        <!-- En-t√™te -->
        <div class="panel-header">
          <h2>
            <span class="header-icon">üí¨</span>
            {{ userRole === 'producer' ? 'Messages clients' : 'Messages
            producteurs' }}
          </h2>

          <div class="header-actions">
            <div class="header-stats">
              <span class="stat">
                <span class="stat-icon">üì®</span>
                {{ getActiveConversationsCount() }} conversations
              </span>
              <span *ngIf="getUnreadCount() > 0" class="stat unread">
                <span class="stat-icon">üîî</span>
                {{ getUnreadCount() }} non lus
              </span>
            </div>

            <!-- Filtres -->
            <div class="conversation-filters">
              <select
                [(ngModel)]="conversationFilter"
                class="filter-select"
                title="Filtrer les conversations"
              >
                <option value="all">Actives</option>
                <option value="unread">Non lues</option>
                <option value="archived">Archiv√©es</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Barre de recherche -->
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input
            type="text"
            [(ngModel)]="searchQuery"
            (input)="onSearchInput()"
            [placeholder]="userRole === 'producer' ? 'Rechercher un client...' : 'Rechercher un producteur...'"
            class="search-input"
            title="Rechercher une conversation"
          />
        </div>

        <!-- Bouton nouvelle conversation -->
        <div
          *ngIf="userRole === 'buyer'"
          class="new-conversation-btn-container"
        >
          <button class="btn-primary" (click)="openNewConversationModal()">
            <span class="btn-icon">‚úâÔ∏è</span>
            <span>Nouvelle conversation</span>
          </button>
        </div>

        <!-- Liste des conversations -->
        <div
          class="conversations-list"
          *ngIf="!isLoading; else loadingConversations"
        >
          <div
            *ngFor="let conversation of filteredConversations; let i = index; trackBy: trackByConversationId"
            class="conversation-item"
            [class.active]="selectedConversation?.id === conversation.id"
            [class.unread]="(userRole === 'buyer' ? conversation.unreadBy.buyer : conversation.unreadBy.producer) > 0"
            [class.archived]="conversation.status === 'archived'"
            (click)="selectConversation(conversation)"
            [attr.data-index]="i"
          >
            <div class="conversation-avatar">
              {{ getOtherUserAvatar(conversation) }}
              <span
                *ngIf="conversation.unreadCount > 0"
                class="unread-dot"
              ></span>
              <span
                *ngIf="conversation.status === 'archived'"
                class="archived-icon"
                >üìÅ</span
              >
            </div>

            <div class="conversation-content">
              <div class="conversation-header">
                <div class="conversation-name">
                  {{ getOtherUserName(conversation) }}
                  <span
                    *ngIf="conversation.isTyping && getOtherUserTyping(conversation)"
                    class="typing-indicator small"
                  >
                    <span>√©crit...</span>
                  </span>
                </div>
                <div class="conversation-time">
                  {{ getConversationTime(conversation) }}
                </div>
              </div>

              <div class="conversation-preview">
                <div
                  class="preview-text"
                  [class.unread]="getConversationUnreadCount(conversation) > 0"
                >
                  {{ getLastMessagePreview(conversation) }}
                </div>
                <div class="conversation-meta">
                  <span *ngIf="conversation.productName" class="product-tag">
                    {{ conversation.productName | slice:0:12 }}{{
                    conversation.productName.length > 12 ? '...' : '' }}
                  </span>
                  <span
                    *ngIf="getConversationUnreadCount(conversation) > 0"
                    class="unread-badge"
                  >
                    {{ getConversationUnreadCount(conversation) }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Aucune conversation -->
          <div
            *ngIf="filteredConversations.length === 0"
            class="empty-conversations"
          >
            <div class="empty-icon">üí¨</div>
            <h3>Aucune conversation</h3>
            <p>
              {{ userRole === 'producer' ? 'Vous n\'avez pas encore de
              conversations avec des clients' : 'Vous n\'avez pas encore de
              conversations avec des producteurs' }}
            </p>
            <button
              *ngIf="userRole === 'buyer'"
              class="btn-primary"
              (click)="openNewConversationModal()"
            >
              <span class="btn-icon">‚úâÔ∏è</span>
              Commencer une conversation
            </button>
          </div>
        </div>

        <ng-template #loadingConversations>
          <div class="loading-conversations">
            <div class="spinner"></div>
            <p>Chargement des conversations...</p>
          </div>
        </ng-template>
      </div>

      <!-- Panel de discussion -->
      <div
        class="chat-panel"
        *ngIf="selectedConversation; else selectConversationPrompt"
      >
        <!-- En-t√™te de la discussion -->
        <div class="chat-header">
          <div class="chat-user">
            <div class="user-avatar">
              {{ getOtherUserAvatar(selectedConversation) }}
            </div>
            <div class="user-info">
              <h3>
                {{ getOtherUserName(selectedConversation) }}
                <span
                  class="user-status"
                  *ngIf="getOtherUserStatus(selectedConversation) === 'online'"
                >
                  <span class="status-dot"></span>
                  En ligne
                </span>
                <span
                  class="user-status"
                  *ngIf="getOtherUserStatus(selectedConversation) === 'offline'"
                >
                  <span class="status-dot offline"></span>
                  Hors ligne
                </span>
              </h3>
              <p *ngIf="selectedConversation.productName">
                √Ä propos de :
                <strong>{{ selectedConversation.productName }}</strong>
              </p>
              <p class="conversation-date">
                Conversation d√©marr√©e le {{
                formatDate(selectedConversation.createdAt) }}
              </p>
              <div *ngIf="otherUserTyping" class="typing-indicator">
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
                <span
                  >{{ getOtherUserName(selectedConversation) }} est en train
                  d'√©crire...</span
                >
              </div>
            </div>
          </div>

          <div class="chat-actions">
            <button
              class="chat-action-btn"
              (click)="toggleArchiveConversation(selectedConversation)"
              [title]="selectedConversation.status === 'archived' ? 'D√©sarchiver' : 'Archiver'"
            >
              {{ selectedConversation.status === 'archived' ? 'üìÇ' : 'üìÅ' }}
            </button>
            <button
              class="chat-action-btn"
              (click)="viewUserProfile(selectedConversation)"
              title="Voir le profil"
            >
              üë§
            </button>
            <button
              class="chat-action-btn"
              (click)="blockUser(selectedConversation)"
              title="Bloquer l'utilisateur"
            >
              üö´
            </button>
            <button
              class="chat-action-btn"
              (click)="deleteConversation(selectedConversation)"
              title="Supprimer la conversation"
            >
              üóëÔ∏è
            </button>
          </div>
        </div>

        <!-- Messages -->
        <div
          #messagesContainer
          class="messages-container-sms"
          (scroll)="onMessagesScroll()"
        >
          <div *ngIf="showLoadMore" class="load-more-container">
            <button
              class="btn-secondary"
              (click)="loadMoreMessages()"
              [disabled]="loadingMoreMessages"
            >
              <span *ngIf="!loadingMoreMessages">Charger plus de messages</span>
              <span *ngIf="loadingMoreMessages">Chargement...</span>
            </button>
          </div>

          <div class="messages-list">
            <div
              *ngFor="let message of messages; let i = index; trackBy: trackByMessageId"
              class="message-wrapper"
              [class.sent]="isSentMessage(message)"
              [class.received]="!isSentMessage(message)"
              [attr.data-message-index]="i"
            >
              <!-- Indicateur de date -->
              <div
                *ngIf="shouldShowDate(message, i)"
                class="message-date-separator"
              >
                <span>{{ getMessageDate(message) }}</span>
              </div>

              <div class="message">
                <!-- Exp√©diteur -->
                <div *ngIf="!isSentMessage(message)" class="message-sender">
                  {{ message.senderName }}
                </div>

                <!-- Contenu du message -->
                <div class="message-content">{{ message.content }}</div>

                <!-- M√©tadonn√©es du message -->
                <div class="message-meta">
                  <span class="message-time"
                    >{{ getMessageTime(message) }}</span
                  >

                  <!-- Statut d'envoi -->
                  <span *ngIf="isSentMessage(message)" class="message-status">
                    {{ getMessageStatusIcon(message) }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Zone de saisie -->
        <div class="message-input-area">
          <div class="input-wrapper">
            <!-- Cherchez cette ligne et corrigez-la -->
            <textarea
              [(ngModel)]="newMessage"
              (keydown)="onMessageKeydown($event)"
              (input)="onMessageInput()"
              [placeholder]="'√âcrivez votre message √† ' + getOtherUserName(selectedConversation) + '...'"
              class="message-input"
              [disabled]="isSendingMessage"
              rows="2"
              title="appuyez"
            ></textarea>
            <button
              class="send-btn"
              (click)="sendMessage()"
              [disabled]="!newMessage.trim() || isSendingMessage"
              [title]="isSendingMessage ? 'Envoi en cours...' : 'Envoyer le message'"
            >
              <span *ngIf="!isSendingMessage" class="send-icon">üì§</span>
              <span *ngIf="isSendingMessage" class="send-icon">‚è≥</span>
            </button>
          </div>

          <!-- Indicateurs -->
          <div class="input-hints">
            <small>Appuyez sur ‚åò + Entr√©e pour un saut de ligne</small>
            <small *ngIf="isTyping" class="typing-hint">Vous √©crivez...</small>
          </div>
        </div>
      </div>

      <!-- Message de s√©lection de conversation -->
      <ng-template #selectConversationPrompt>
        <div class="select-conversation-prompt">
          <div class="prompt-icon">üí¨</div>
          <h2>S√©lectionnez une conversation</h2>
          <p>
            {{ userRole === 'producer' ? 'Choisissez une conversation avec un
            client pour commencer √† discuter' : 'Choisissez une conversation
            avec un producteur pour commencer √† discuter' }}
          </p>

          <div class="prompt-tips">
            <h4>üí° Conseils pour une bonne communication :</h4>
            <ul>
              <li *ngIf="userRole === 'producer'">
                <strong>Rapidit√© :</strong> R√©pondez dans les 24 heures maximum
              </li>
              <li *ngIf="userRole === 'buyer'">
                <strong>Respect :</strong> Soyez poli et respectueux du temps du
                producteur
              </li>
              <li>
                <strong>Clart√© :</strong> Soyez pr√©cis sur les prix et
                disponibilit√©s
              </li>
              <li>
                <strong>Professionalisme :</strong> Utilisez un langage poli et
                courtois
              </li>
              <li>
                <strong>Transparence :</strong> Informez des d√©lais de livraison
                r√©els
              </li>
            </ul>
          </div>

          <button
            *ngIf="userRole === 'buyer'"
            class="btn-primary mt-4"
            (click)="openNewConversationModal()"
          >
            <span class="btn-icon">‚úâÔ∏è</span>
            Nouvelle conversation
          </button>
        </div>
      </ng-template>
    </div>
  </main>
</div>

<!-- Modal pour d√©marrer une nouvelle conversation -->
<div class="modal-overlay" *ngIf="modalData.show">
  <div class="modal-content">
    <div class="modal-header">
      <h3>D√©marrer une nouvelle conversation</h3>
      <button
        class="modal-close"
        (click)="closeModal()"
        [disabled]="modalData.isLoading"
      >
        √ó
      </button>
    </div>

    <div class="modal-body">
      <!-- Recherche de producteur -->
      <div class="producer-search">
        <input
          type="text"
          [(ngModel)]="modalData.searchQuery"
          (input)="onProducerSearch()"
          placeholder="Rechercher un producteur par nom, ferme ou localisation..."
          class="search-input"
          [disabled]="modalData.isLoading"
        />
      </div>

      <!-- Liste des producteurs -->
      <div
        class="producers-list"
        *ngIf="!modalData.isLoading; else loadingProducers"
      >
        <div
          *ngFor="let producer of filteredProducers; trackBy: trackByProducerId"
          class="producer-item"
          [class.selected]="modalData.selectedProducerId === producer.id"
          (click)="selectProducer(producer)"
        >
          <div class="producer-avatar">{{ producer.avatar || 'üë®‚Äçüåæ' }}</div>

          <div class="producer-info">
            <h4>{{ producer.name }}</h4>
            <p class="producer-farm">{{ producer.farmName }}</p>
            <p class="producer-location">üìç {{ producer.location }}</p>

            <div class="producer-stats">
              <span class="producer-rating">
                ‚≠ê {{ producer.rating.toFixed(1) }} ({{ producer.reviews }}
                avis)
              </span>
              <span class="producer-response">
                üì® {{ producer.responseRate }}% r√©ponse ‚Ä¢ ‚è±Ô∏è {{
                producer.averageResponseTime }} min
              </span>
            </div>

            <p class="producer-description">{{ producer.description }}</p>

            <div class="producer-tags">
              <span *ngIf="producer.isOrganic" class="tag organic">üå± Bio</span>
              <span
                *ngFor="let cert of producer.certifications.slice(0, 2)"
                class="tag certification"
              >
                üèÖ {{ cert }}
              </span>
              <span *ngIf="producer.productsCount > 0" class="tag products">
                üì¶ {{ producer.productsCount }} produits
              </span>
              <span *ngIf="producer.isOnline" class="tag online"
                >üü¢ En ligne</span
              >
            </div>
          </div>
        </div>

        <!-- Aucun producteur trouv√© -->
        <div
          *ngIf="filteredProducers.length === 0 && modalData.searchQuery"
          class="no-producers"
        >
          <div class="no-producers-icon">üîç</div>
          <h4>Aucun producteur trouv√©</h4>
          <p>Essayez avec d'autres termes de recherche</p>
        </div>
      </div>

      <ng-template #loadingProducers>
        <div class="loading-producers">
          <div class="spinner"></div>
          <p>Recherche des producteurs...</p>
        </div>
      </ng-template>

      <!-- Formulaire de message -->
      <div *ngIf="modalData.selectedProducerId" class="message-to-producer">
        <h4>Votre message √† {{ getSelectedProducerName() }}</h4>
        <textarea
          [(ngModel)]="modalData.message"
          (input)="onModalMessageInput()"
          placeholder="√âcrivez votre message ici. Soyez clair sur ce que vous souhaitez demander ou commander..."
          rows="4"
          class="message-textarea"
          [disabled]="modalData.isLoading"
          maxlength="500"
        ></textarea>

        <div class="character-count">
          {{ modalData.message.length }} / 500 caract√®res
        </div>

        <!-- Suggestions de message -->
        <div class="message-suggestions" *ngIf="!modalData.message.trim()">
          <h5>Suggestions de message :</h5>
          <div class="suggestions-list">
            <button
              class="suggestion-btn"
              (click)="modalData.message = 'Bonjour, je souhaiterais commander vos produits. Pourriez-vous m\'indiquer les disponibilit√©s et les prix ?'"
            >
              Demande d'information sur les produits
            </button>
            <button
              class="suggestion-btn"
              (click)="modalData.message = 'Bonjour, je suis int√©ress√© par vos produits. Quelle est la proc√©dure pour passer commande ?'"
            >
              Demande de proc√©dure de commande
            </button>
            <button
              class="suggestion-btn"
              (click)="modalData.message = 'Bonjour, je voudrais savoir si vous faites des livraisons dans ma r√©gion et quels sont les d√©lais.'"
            >
              Demande sur la livraison
            </button>
          </div>
        </div>

        <!-- Actions du modal -->
        <div class="modal-actions">
          <button
            class="btn-secondary"
            (click)="closeModal()"
            [disabled]="modalData.isLoading"
          >
            Annuler
          </button>
          <button
            class="btn-primary"
            (click)="startConversation()"
            [disabled]="!modalData.message.trim() || modalData.isLoading"
          >
            <span *ngIf="modalData.isLoading">Envoi en cours...</span>
            <span *ngIf="!modalData.isLoading">Envoyer le message</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de profil utilisateur -->
<div class="modal-overlay" *ngIf="profileModalData.show">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Profil de {{ profileModalData.userName }}</h3>
      <button class="modal-close" (click)="closeProfileModal()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="profile-content">
        <div class="profile-header">
          <div class="profile-avatar">{{ profileModalData.userAvatar }}</div>
          <div class="profile-info">
            <h4>{{ profileModalData.userName }}</h4>
            <p class="profile-role">
              {{ profileModalData.userRole === 'producer' ? 'Producteur' :
              'Acheteur' }}
            </p>
            <p class="profile-location" *ngIf="profileModalData.location">
              üìç {{ profileModalData.location }}
            </p>
          </div>
        </div>

        <div class="profile-details">
          <div class="detail-section">
            <h5>Informations</h5>
            <div class="detail-item" *ngIf="profileModalData.email">
              <span class="detail-label">Email :</span>
              <span class="detail-value">{{ profileModalData.email }}</span>
            </div>
            <div class="detail-item" *ngIf="profileModalData.phone">
              <span class="detail-label">T√©l√©phone :</span>
              <span class="detail-value">{{ profileModalData.phone }}</span>
            </div>
            <div class="detail-item" *ngIf="profileModalData.joinedDate">
              <span class="detail-label">Membre depuis :</span>
              <span class="detail-value"
                >{{ formatDate(profileModalData.joinedDate) }}</span
              >
            </div>
          </div>

          <div
            class="detail-section"
            *ngIf="profileModalData.userRole === 'producer'"
          >
            <h5>Informations de la ferme</h5>
            <div class="detail-item" *ngIf="profileModalData.farmName">
              <span class="detail-label">Nom de la ferme :</span>
              <span class="detail-value">{{ profileModalData.farmName }}</span>
            </div>
            <div class="detail-item" *ngIf="profileModalData.description">
              <span class="detail-label">Description :</span>
              <span class="detail-value"
                >{{ profileModalData.description }}</span
              >
            </div>
            <div
              class="detail-item"
              *ngIf="profileModalData.certifications?.length"
            >
              <span class="detail-label">Certifications :</span>
              <span class="detail-value">
                {{ profileModalData.certifications?.join(', ') }}
              </span>
            </div>
          </div>

          <div class="detail-section" *ngIf="profileModalData.stats">
            <h5>Statistiques</h5>
            <div class="detail-item" *ngIf="profileModalData.stats.rating">
              <span class="detail-label">Note moyenne :</span>
              <span class="detail-value"
                >‚≠ê {{ profileModalData.stats.rating.toFixed(1) }}/5</span
              >
            </div>
            <div
              class="detail-item"
              *ngIf="profileModalData.stats.responseRate"
            >
              <span class="detail-label">Taux de r√©ponse :</span>
              <span class="detail-value"
                >{{ profileModalData.stats.responseRate }}%</span
              >
            </div>
            <div
              class="detail-item"
              *ngIf="profileModalData.stats.responseTime"
            >
              <span class="detail-label">Temps de r√©ponse moyen :</span>
              <span class="detail-value"
                >{{ profileModalData.stats.responseTime }} min</span
              >
            </div>
          </div>
        </div>

        <div class="profile-actions">
          <button class="btn-secondary" (click)="closeProfileModal()">
            Fermer
          </button>
          <button
            class="btn-primary"
            (click)="startNewConversationFromProfile()"
          >
            <span class="btn-icon">‚úâÔ∏è</span>
            Envoyer un message
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
