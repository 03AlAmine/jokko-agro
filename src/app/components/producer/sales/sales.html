<div class="sales-container">
  <!-- En-t√™te -->
  <header class="sales-header">
    <div class="header-content">
      <div class="header-title">
        <h1>üí∞ Historique des Ventes</h1>
        <p class="subtitle">Suivez vos performances et g√©rez vos commandes</p>
      </div>
      <div class="header-actions">
        <button
          class="btn btn-primary"
          (click)="exportSales()"
          [disabled]="isExporting || filteredSales.length === 0"
        >
          <span class="btn-icon">{{ isExporting ? '‚è≥' : 'üìÑ' }}</span>
          {{ isExporting ? 'Export en cours...' : 'Exporter CSV' }}
        </button>
      </div>
    </div>
  </header>

  <!-- Statistiques principales -->
  <section class="stats-section" *ngIf="!isLoading">
    <div class="stats-grid">
      <div
        *ngFor="let card of statCards"
        class="stat-card"
        [style.borderLeftColor]="card.color"
      >
        <div class="stat-icon" [style.backgroundColor]="card.color + '20'">
          {{ card.icon }}
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ formatStatValue(card) }}</div>
          <div class="stat-label">{{ card.label }}</div>
          <div
            class="stat-trend"
            [class.trend-up]="card.trend === 'up'"
            [class.trend-down]="card.trend === 'down'"
          >
            {{ card.trend === 'up' ? '‚Üë' : '‚Üì' }} {{ abs(card.change) }}%
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Filtres -->
  <section class="filters-section">
    <div class="filters-card">
      <div class="search-container">
        <div class="search-icon">üîç</div>
        <input
          type="text"
          [(ngModel)]="filter.searchQuery"
          (ngModelChange)="applyFilters()"
          placeholder="Rechercher commande, produit ou client..."
          class="search-input"
        />
      </div>

      <div class="filters-grid">
        <div class="filter-group">
          <label>üìÖ P√©riode</label>
          <select [(ngModel)]="filter.period" (ngModelChange)="applyFilters()" title="p√©riode">
            <option *ngFor="let period of periods" [value]="period.id">
              {{ period.name }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label>üìä Statut</label>
          <select [(ngModel)]="filter.status" (ngModelChange)="applyFilters()" title="statut">
            <option *ngFor="let status of statuses" [value]="status.id">
              {{ status.name }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label>üí≥ Paiement</label>
          <select
            [(ngModel)]="filter.paymentMethod"
            (ngModelChange)="applyFilters()"
            title="m√©thode de paiement"
          >
            <option *ngFor="let method of paymentMethods" [value]="method.id">
              {{ method.name }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label>üöö Livraison</label>
          <select
            [(ngModel)]="filter.deliveryType"
            (ngModelChange)="applyFilters()"
            title="livraison"
          >
            <option *ngFor="let type of deliveryTypes" [value]="type.id">
              {{ type.name }}
            </option>
          </select>
        </div>

        <button class="btn btn-secondary" (click)="clearFilters()">
          ‚úï Effacer filtres
        </button>
      </div>
    </div>
  </section>

  <!-- Graphiques et insights -->
  <section class="insights-section" *ngIf="!isLoading && stats">
    <div class="insights-grid">
      <!-- Graphique revenus -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>üìà √âvolution des revenus</h3>
          <span class="chart-subtitle"
            >Derniers {{ stats.monthlyRevenue.length }} mois</span
          >
        </div>
        <div class="chart-container">
          <div class="chart-bars" *ngIf="stats.monthlyRevenue.length > 0">
            <div
              *ngFor="let month of stats.monthlyRevenue"
              class="chart-bar-group"
            >
              <div class="bar-label">{{ month.month }}</div>
              <div class="bar-container">
                <div
                  class="bar-fill"
                  [style.height]="(month.revenue / (getMaxRevenue() || 1) * 100) + '%'"
                  [style.backgroundColor]="'#4CAF50'"
                ></div>
              </div>
              <div class="bar-value">
                {{ (month.revenue / 1000).toFixed(0) }}K FCFA
              </div>
            </div>
          </div>
          <div *ngIf="stats.monthlyRevenue.length === 0" class="chart-empty">
            <p>Aucune donn√©e disponible</p>
          </div>
        </div>
      </div>

      <!-- Top produits -->
      <div class="insight-card">
        <div class="insight-header">
          <h3>üèÜ Top produits</h3>
          <span class="insight-subtitle">Par revenus g√©n√©r√©s</span>
        </div>
        <div class="insight-list">
          <div
            *ngFor="let product of stats.topProducts; let i = index"
            class="insight-item"
          >
            <div class="item-rank">#{{ i + 1 }}</div>
            <div class="item-info">
              <div class="item-name">{{ product.productName }}</div>
              <div class="item-meta">{{ product.salesCount }} ventes</div>
            </div>
            <div class="item-value">{{ formatPrice(product.revenue) }}</div>
          </div>
          <div *ngIf="stats.topProducts.length === 0" class="insight-empty">
            <p>Aucun produit vendu</p>
          </div>
        </div>
      </div>

      <!-- Statistiques d√©taill√©es -->
      <div class="stats-detail-card">
        <div class="stats-detail-header">
          <h3>üìä Statistiques d√©taill√©es</h3>
        </div>
        <div class="stats-detail-grid">
          <div class="detail-item">
            <div class="detail-label">Meilleur jour</div>
            <div class="detail-value">{{ stats.bestSellingDay }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Heure de pointe</div>
            <div class="detail-value">{{ stats.peakHour }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Tendance mensuelle</div>
            <div
              class="detail-value"
              [class.positive]="isPositiveTrend()"
              [class.negative]="isNegativeTrend()"
            >
              {{ formatTrend(stats.monthlyTrend) }}
            </div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Commandes actives</div>
            <div class="detail-value">{{ stats.activeOrders }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Paiement le plus utilis√©</div>
            <div class="detail-value">{{ getMostUsedPaymentMethod() }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Revenu pr√©dit</div>
            <div class="detail-value">
              {{ formatPrice(stats.predictedRevenue || 0) }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Liste des ventes -->
  <section class="sales-list-section">
    <div class="section-header">
      <h2>üìã Commandes ({{ filteredSales.length }})</h2>
      <div class="section-summary">
        <span class="summary-total">
          Total: {{ formatPrice(totalFilteredSales) }}
        </span>
        <span class="summary-count">{{ filteredSales.length }} commandes</span>
      </div>
    </div>

    <!-- √âtats de chargement et vide -->
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner"></div>
      <p>Chargement des ventes...</p>
    </div>

    <div *ngIf="!isLoading && filteredSales.length === 0" class="empty-state">
      <div class="empty-icon">üì≠</div>
      <h3>Aucune vente trouv√©e</h3>
      <p>Modifiez vos filtres ou attendez de nouvelles commandes</p>
      <button class="btn btn-primary" (click)="clearFilters()">
        R√©initialiser les filtres
      </button>
    </div>

    <!-- Tableau des ventes -->
    <div
      *ngIf="!isLoading && filteredSales.length > 0"
      class="sales-table-container"
    >
      <table class="sales-table">
        <thead>
          <tr>
            <th>Commande</th>
            <th>Date</th>
            <th>Produit</th>
            <th>Client</th>
            <th>Quantit√©</th>
            <th>Montant</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let sale of paginatedSales">
            <td class="order-number">
              <strong>{{ sale.orderNumber }}</strong>
            </td>
            <td class="order-date">{{ formatDate(sale.orderDate) }}</td>
            <td class="product-info">
              <div class="product-name">{{ sale.productName }}</div>
              <div class="product-category">{{ sale.productCategory }}</div>
            </td>
            <td class="customer-info">
              <div class="customer-name">{{ sale.buyerName }}</div>
              <div class="customer-phone">{{ sale.buyerPhone }}</div>
            </td>
            <td class="quantity">
              {{ sale.quantity }} {{ getProductUnit(sale) }}
            </td>
            <td class="amount">
              <div class="amount-total">
                {{ formatPrice(sale.totalAmount) }}
              </div>
              <div class="amount-unit">
                {{ formatPrice(sale.unitPrice) }}/{{ getProductUnit(sale) }}
              </div>
            </td>
            <td class="status-cell">
              <span [class]="'status-badge ' + getStatusClass(sale.status)">
                {{ getStatusText(sale.status) }}
              </span>
            </td>
            <td class="actions-cell">
              <div class="actions-group">
                <button
                  class="btn-icon"
                  (click)="viewSaleDetails(sale)"
                  title="Voir d√©tails"
                >
                  üëÅÔ∏è
                </button>
                <select
                  (change)="updateSaleStatus(sale.id, $any($event.target).value)"
                  class="status-select"
                  *ngIf="sale.status !== 'completed' && sale.status !== 'cancelled'"
                  title="Changer statut"
                >
                  <option value="">Actions</option>
                  <option value="confirmed">Confirmer</option>
                  <option value="shipped">Exp√©dier</option>
                  <option value="delivered">Livrer</option>
                  <option value="completed">Terminer</option>
                  <option value="cancelled">Annuler</option>
                </select>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination" *ngIf="totalPages > 1">
        <button
          class="pagination-btn"
          (click)="prevPage()"
          [disabled]="currentPage === 1"
        >
          ‚Üê Pr√©c√©dent
        </button>

        <div class="pagination-numbers">
          <button
            *ngFor="let page of getPageNumbers()"
            class="pagination-number"
            [class.active]="page === currentPage"
            (click)="goToPage(page)"
          >
            {{ page }}
          </button>
        </div>

        <button
          class="pagination-btn"
          (click)="nextPage()"
          [disabled]="currentPage === totalPages"
        >
          Suivant ‚Üí
        </button>
      </div>
    </div>
  </section>

  <!-- Insights et recommandations -->
  <section class="recommendations-section" *ngIf="!isLoading && stats">
    <div class="recommendations-grid">
      <div class="recommendation-card">
        <div class="recommendation-icon">üí°</div>
        <h4>Insights</h4>
        <ul>
          <li *ngIf="stats.topProducts.length > 0">
            <strong>{{ stats.topProducts[0].productName }}</strong> est votre
            produit le plus vendu
          </li>
          <li>
            <strong>{{ getMostUsedPaymentMethod() }}</strong> est la m√©thode de
            paiement pr√©f√©r√©e
          </li>
          <li *ngIf="stats.topBuyers.length > 0">
            <strong>{{ stats.topBuyers[0].buyerName }}</strong> est votre
            meilleur client
          </li>
          <li>
            Taux de compl√©tion:
            <strong>{{ stats.completionRate.toFixed(1) }}%</strong>
          </li>
        </ul>
      </div>

      <div class="recommendation-card">
        <div class="recommendation-icon">üéØ</div>
        <h4>Recommandations</h4>
        <ul>
          <li>Augmentez le stock de vos produits populaires</li>
          <li>Proposez des promotions sur les produits moins vendus</li>
          <li>Am√©liorez vos d√©lais de livraison</li>
          <li>Demandez des √©valuations apr√®s chaque vente</li>
        </ul>
      </div>

      <div class="recommendation-card">
        <div class="recommendation-icon">üìà</div>
        <h4>Objectifs</h4>
        <ul>
          <li>
            Atteindre {{ formatPrice((stats.totalRevenue || 0) * 1.2) }} de
            revenus ce mois
          </li>
          <li>Augmenter le taux de compl√©tion √† 95%</li>
          <li>Obtenir une note moyenne de 4.5/5</li>
          <li>R√©duire les commandes annul√©es √† moins de 2%</li>
        </ul>
      </div>
    </div>
  </section>
</div>
