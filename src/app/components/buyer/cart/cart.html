<div class="cart-container">
  <!-- En-t√™te -->
  <div class="cart-header">
    <div class="header-left">
      <h1><span class="header-icon">üõí</span> Mon Panier</h1>
      <p class="subtitle">V√©rifiez vos articles et passez √† la caisse</p>
    </div>
    <div class="header-right">
      <button class="continue-btn" (click)="continueShopping()">
        ‚Üê Continuer mes achats
      </button>
    </div>
  </div>

  <!-- Message panier vide -->
  <div *ngIf="cartItems.length === 0" class="empty-cart">
    <div class="empty-icon">üõí</div>
    <h2>Votre panier est vide</h2>
    <p>Ajoutez des produits frais depuis le march√©</p>
    <button class="btn-primary" routerLink="/buyer/market">
      üõçÔ∏è D√©couvrir le march√©
    </button>
  </div>

  <!-- Contenu du panier -->
  <div *ngIf="cartItems.length > 0" class="cart-content">
    <div class="cart-layout">
      <!-- Section gauche : Articles -->
      <div class="cart-items-section">
        <!-- En-t√™te des articles -->
        <div class="items-header">
          <div class="select-all">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [checked]="areAllItemsSelected()"
                (change)="selectAllItems()"
              />
              <span class="checkbox-custom"></span>
              <span class="checkbox-text"
                >Tout s√©lectionner ({{ getSelectedItemsCount() }})</span
              >
            </label>
          </div>
          <div class="items-count">
            {{ cartItems.length }} article{{ cartItems.length > 1 ? 's' : '' }}
          </div>
        </div>

        <!-- Liste des articles -->
        <div class="items-list">
          <div *ngFor="let item of cartItems" class="cart-item">
            <div class="item-select">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="item.selected"
                  (change)="toggleSelectItem(item.id)"
                />
                <span class="checkbox-custom"></span>
              </label>
            </div>

            <div class="item-image">
              {{ item.image }}
              <span *ngIf="item.certified" class="certified-badge">‚úî</span>
            </div>

            <div class="item-details">
              <div class="item-header">
                <h3 class="item-name">{{ item.name }}</h3>
                <button
                  class="remove-btn"
                  (click)="removeItem(item.id)"
                  title="Retirer"
                >
                  ‚úï
                </button>
              </div>

              <div class="item-producer">Producteur: {{ item.producer }}</div>

              <div class="item-badges">
                <span *ngIf="item.certified" class="badge certified"
                  >Certifi√©</span
                >
                <span *ngIf="item.organic" class="badge organic">Bio</span>
                <span class="badge delivery">
                  {{ item.deliveryType === 'pickup' ? '√Ä retirer' : 'Livraison'
                  }}
                </span>
              </div>

              <div class="item-notes">
                <input
                  type="text"
                  [value]="item.notes || ''"
                  (input)="updateItemNotes(item.id, $any($event.target).value)"
                  placeholder="Ajouter une note pour le producteur..."
                  class="notes-input"
                />
              </div>
            </div>

            <div class="item-quantity">
              <div class="quantity-controls">
                <button
                  class="qty-btn"
                  (click)="updateQuantity(item.id, -1)"
                  [disabled]="item.quantity <= 1"
                >
                  ‚àí
                </button>
                <span class="qty-value"
                  >{{ item.quantity }} {{ item.unit }}</span
                >
                <button
                  class="qty-btn"
                  (click)="updateQuantity(item.id, 1)"
                  [disabled]="item.quantity >= item.maxQuantity"
                >
                  +
                </button>
              </div>
              <div class="qty-max">Max: {{ item.maxQuantity }}</div>
            </div>

            <div class="item-price">
              <div class="price-main">
                {{ formatPrice(item.price * item.quantity) }}
              </div>
              <div class="price-unit">
                {{ formatPrice(item.price) }} / {{ item.unit }}
              </div>
              <div *ngIf="getItemDeliveryFee(item) > 0" class="price-delivery">
                + {{ formatPrice(getItemDeliveryFee(item)) }} livraison
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section droite : R√©capitulatif -->
      <div class="cart-summary-section">
        <!-- R√©capitulatif de commande -->
        <div class="summary-card">
          <h3>R√©capitulatif de commande</h3>

          <div class="summary-details">
            <div class="summary-row">
              <span
                >Sous-total ({{ getSelectedItemsCount() }} article{{
                getSelectedItemsCount() > 1 ? 's' : '' }})</span
              >
              <span>{{ formatPrice(getSubtotal()) }}</span>
            </div>

            <div class="summary-row">
              <span>Frais de livraison</span>
              <span>{{ formatPrice(getDeliveryFee()) }}</span>
            </div>

            <div class="summary-row">
              <span>Frais de paiement</span>
              <span>{{ formatPrice(getPaymentFee()) }}</span>
            </div>

            <!-- Coupon -->
            <div class="coupon-section">
              <div *ngIf="!appliedCoupon" class="coupon-input">
                <input
                  type="text"
                  [(ngModel)]="couponCode"
                  placeholder="Code promo"
                  class="coupon-field"
                />
                <button class="coupon-btn" (click)="applyCoupon()">
                  Appliquer
                </button>
              </div>

              <div *ngIf="appliedCoupon" class="coupon-applied">
                <div class="coupon-info">
                  <span class="coupon-code">{{ appliedCoupon.code }}</span>
                  <span class="coupon-discount">
                    -{{ appliedCoupon.discount }}{{ appliedCoupon.type ===
                    'percentage' ? '%' : ' FCFA' }}
                  </span>
                </div>
                <button class="coupon-remove" (click)="removeCoupon()">
                  ‚úï
                </button>
              </div>
            </div>

            <div *ngIf="appliedCoupon" class="summary-row discount">
              <span>R√©duction coupon</span>
              <span>-{{ formatPrice(getCouponDiscount()) }}</span>
            </div>
          </div>

          <div class="summary-total">
            <span>Total</span>
            <span class="total-amount">{{ formatPrice(getTotal()) }}</span>
          </div>
        </div>

        <!-- Options de livraison -->
        <div class="delivery-card">
          <h3>üì¶ Options de livraison</h3>

          <div class="delivery-options">
            <div
              *ngFor="let option of deliveryOptions"
              class="delivery-option"
              [class.selected]="selectedDeliveryOption === option.id"
              (click)="selectedDeliveryOption = option.id"
            >
              <div class="option-header">
                <div class="option-name">{{ option.name }}</div>
                <div class="option-price">{{ formatPrice(option.price) }}</div>
              </div>

              <div class="option-details">
                <div class="option-time">‚è±Ô∏è {{ option.time }}</div>
                <p class="option-description">{{ option.description }}</p>
              </div>
            </div>
          </div>

          <!-- Adresse de livraison -->
          <div
            *ngIf="selectedDeliveryOption.includes('delivery')"
            class="delivery-address"
          >
            <h4>Adresse de livraison</h4>

            <div class="address-form">
              <div class="form-group">
                <input
                  type="text"
                  [(ngModel)]="deliveryAddress.street"
                  placeholder="Adresse compl√®te"
                  class="form-input"
                />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <select [(ngModel)]="deliveryAddress.city" class="form-input">
                    <option value="Dakar">Dakar</option>
                    <option value="Thi√®s">Thi√®s</option>
                    <option value="Saint-Louis">Saint-Louis</option>
                    <option value="Ziguinchor">Ziguinchor</option>
                  </select>
                </div>

                <div class="form-group">
                  <input
                    type="tel"
                    [(ngModel)]="deliveryAddress.phone"
                    placeholder="T√©l√©phone"
                    class="form-input"
                  />
                </div>
              </div>

              <div class="form-group">
                <textarea
                  [(ngModel)]="deliveryAddress.instructions"
                  placeholder="Instructions de livraison (porte, √©tage, etc.)"
                  class="form-textarea"
                  rows="2"
                ></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- M√©thodes de paiement -->
        <div class="payment-card">
          <h3>üí≥ M√©thode de paiement</h3>

          <div class="payment-options">
            <div
              *ngFor="let method of paymentMethods"
              class="payment-option"
              [class.selected]="selectedPaymentMethod === method.id"
              (click)="selectedPaymentMethod = method.id"
            >
              <div class="payment-icon">{{ method.icon }}</div>
              <div class="payment-info">
                <div class="payment-name">{{ method.name }}</div>
                <div class="payment-description">{{ method.description }}</div>
              </div>
              <div class="payment-fee">
                {{ method.fee > 0 ? '+' + formatPrice(method.fee) : 'Gratuit' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Bouton de commande -->
        <div class="checkout-card">
          <div class="checkout-summary">
            <div class="checkout-total">
              <span>Total √† payer</span>
              <span class="amount">{{ formatPrice(getTotal()) }}</span>
            </div>
            <p class="checkout-note">
              Inclut les frais de livraison et de paiement
            </p>
          </div>

          <button
            class="checkout-btn"
            (click)="proceedToCheckout()"
            [disabled]="!canCheckout() || isCheckingOut"
            [class.loading]="isCheckingOut"
          >
            <span *ngIf="!isCheckingOut" class="btn-content">
              <span class="btn-icon">‚úÖ</span>
              Commander maintenant
            </span>

            <span *ngIf="isCheckingOut" class="btn-content">
              <span class="spinner"></span>
              Traitement en cours...
            </span>
          </button>

          <p class="secure-payment">
            üîí Paiement s√©curis√© ‚Ä¢ Garantie blockchain
          </p>
        </div>
      </div>
    </div>

    <!-- Conseils et informations -->
    <div class="cart-tips">
      <div class="tip-card">
        <h4>üí° Pourquoi acheter chez nous ?</h4>
        <ul>
          <li>‚úÖ Produits certifi√©s blockchain</li>
          <li>‚úÖ Producteurs v√©rifi√©s</li>
          <li>‚úÖ Paiements s√©curis√©s</li>
          <li>‚úÖ Livraison garantie</li>
        </ul>
      </div>

      <div class="tip-card">
        <h4>üõ°Ô∏è Garanties incluses</h4>
        <ul>
          <li>Authenticit√© v√©rifi√©e par QR code</li>
          <li>Tra√ßabilit√© compl√®te du produit</li>
          <li>Remboursement sous 48h si probl√®me</li>
          <li>Support client 7j/7</li>
        </ul>
      </div>

      <div class="tip-card">
        <h4>üì± Acheter en toute confiance</h4>
        <p>
          Scannez les QR codes pour v√©rifier l'authenticit√© de chaque produit
          avant l'achat.
        </p>
        <button routerLink="/buyer/scan" class="scan-btn">
          üì± Tester le scanner
        </button>
      </div>
    </div>
  </div>
</div>
